---
- name: Deploy ELK stack
  hosts: VBOX
  become: true
  vars:
    elasticsearch_jvm_min: "1024M"
    elasticsearch_jvm_max: "1024M"


  tasks:
    - name: Include include_role
      ansible.builtin.include_tasks:
        file: "playbook1.yml"
  
    - name: Install https-transport
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - openssl
          - default-jdk
        state: present
        update_cache: true

    - name: Import the Elastic Key
      ansible.builtin.apt_key:
        url: "https://artifacts.elastic.co/GPG-KEY-elasticsearch"
        state: present

    - name: Adding Elastic APT repository
      ansible.builtin.apt_repository:
        repo: "deb https://artifacts.elastic.co/packages/7.x/apt stable main"
        state: present
        filename: "elastic-7.x.list"
        update_cache: true

    - name: Install elasticsearch
      ansible.builtin.apt:
        name: elasticsearch
        state: present
        update-cache: true

    - name: Enable start elasticsearch
      ansible.builtin.service:
        name: elasticsearch
        state: started
        enabled: true

    # - name: Updating the config file to allow outside access
    #   ansible.builtin.lineinfile:
    #     destfile: /etc/elasticsearch/elasticsearch.yml
    #     regexp: 'network.host:'
    #     line: 'network.host: 0.0.0.0'

    # - name: Updating the port in config file
    #   ansible.builtin.lineinfile:
    #     destfile: /etc/elasticsearch/elasticsearch.yml
    #     regexp: 'http.port:'
    #     line: 'http.port: 9200'
    - name: Copy elasticsearch config
      ansible.builtin.copy:
        src: "files/elasticsearch.yml"
        dest: "/etc/elasticsearch/elasticsearch.yml"
        owner: root
        group: elasticsearch

    - name: Set min JVM Heap size
      ansible.builtin.lineinfile:
        dest: "/etc/elasticsearch/jvm.options"
        regexp: "^-Xms"
        line: "-Xms{{ elasticsearch_jvm_min }}"

    - name: Set max JVM Heap size
      ansible.builtin.lineinfile:
        dest: "/etc/elasticsearch/jvm.options"
        regexp: "^-Xmx"
        line: "-Xmx{{ elasticsearch_jvm_max }}"
      notify: Restart_elasticsearch

    - name: Logstash install
      ansible.builtin.apt:
        name: logstash
        state: present
        update_cache: true

    - name: Enable start logstash
      ansible.builtin.service:
        name: logstash
        state: started
        enabled: true
  
    - name: Copy logstash pipeline config
      ansible.builtin.template:
        src: "templates/wordpress.cong.j2"
        dest: "/etc/logstash/conf.d/wordpress.conf"
        owner: root
        group: logstash
        mode: "0644"
      notify: Restart_logstash

    - name: Kibana install
      ansible.builtin.apt:
        name: kibana
        state: present
        update_cache: true

    - name: Enable Kibana
      ansible.builtin.service:
        name: kibana
        state: started
        enabled: true


    - name: Copy Kibana config
      ansible.builtin.copy:
        src: "files/kibana.yml"
        dest: "/etc/kibana/kibana.yml"
        owner: root
        group: kibana
        mode: "0644"
      notify: Restart_Kibana

    # - name: Install nginx
    #   ansible.builtin.apt:
    #     name:
    #       - nginx
    #     state: present
    #     update_cache: true

    - name: Filebeat install
      ansible.builtin.apt:
        name:
          - filebeat
        state: present
        update_cache: true
  
    - name: Enable Filebeat service
      ansible.builtin.service:
        name: filebeat
        state: started
        enabled: true

    - name: Copy Filebeat config
      ansible.builtin.template:
        src: "templates/filebeat.yml.j2"
        dest: "/etc/filebeat/filebeat.yml"
        owner: root
        group: filebeat
      notify: Restart_filebeat


  handlers:
    - name: Restart_elasticsearch
      ansible.builtin.service:
        name: elasticsearch
        state: restarted

    - name: Restart_Kibana
      ansible.builtin.service:
        name: kibana
        state: restarted

    - name: Restart_NGINX
      ansible.builtin.service:
        name: nginx
        state: restarted

    - name: Restart_filebeat
      ansible.builtin.service:
        name: filebeat
        state: restarted

    - name: Restart_logstash
      ansible.builtin.service:
        name: logstash
        state: restarted